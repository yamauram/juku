# DynamoDB を使用した Spring アプリケーションの検証

## 背景・目的

- サーバレス API の検証で API Gateway + Lambda による構成での疎通はできたが、コールドスタートにより初回起動時のレスポンスに多大な時間がかかることがわかった。
- コールドスタート問題に対処する方法はいくつかあるが、起動の遅い VPC Lambda から非 VPC Lambda に変更することで高速化が図れないか検証する。
- 非 VPC Lambda に変更するため、受付情報の永続化に、RDS ではなく DynamoDB を使用する。

## 環境構築

### AWS リソースの設定

- DynamoDB で以下のテーブルを作成する。

  - reception（受付情報管理テーブル）
     - `id`（自動生成する一意の文字列）をパーティションキーとし、以下の属性を持つ。
       - `request_file_path`（要求ファイルパス）
       - `response_file_path`（回答ファイルパス）
       - `status`（ステータス）
       - `reception_time`（受付日時）
- Lambda の IAM ロールに DynamoDB のアクセス権限を追加する。

### アプリケーションの設定

- `pom.xml`に以下の依存を追加する。
  ```
  <dependency>
    <groupId>com.github.derjust</groupId>
    <artifactId>spring-data-dynamodb</artifactId>
  </dependency>
  ```
- DynamoDbConfig を作成

  - DynamoDB 接続用の Config クラスを作成する。

  ```java
  @Configuration
  @EnableDynamoDBRepositories(basePackages = "org.debugroom.mynavi.sample.spring.data.dynamodb.domain.repository")
  public class DynamoDBConfig {

    @Value("${amazon.dynamodb.region}")
    private String region;
    @Value("${amazon.dynamodb.endpoint}")
    private String endpoint;

    @Bean
    public AmazonDynamoDB amazonDynamoDB(){
        return AmazonDynamoDBClientBuilder.standard().withEndpointConfiguration(
             new AwsClientBuilder.EndpointConfiguration(endpoint, region)).build();
    }
  }
  ```

- application.yml の設定
  - `application.yml`に DynamoDB への接続情報を設定する。
  ```yaml
  amazon:
    dynamodb:
      region: ap-northeast-1
      endpoint: https://dynamodb.ap-northeast-1.amazonaws.com
  ```
- エンティティクラスに`@DynamoDBTable`を付与。IDは`@DynamoDBAutoGeneratedKey`により自動生成。

  ``` java
  @Data
  @Builder
  @NoArgsConstructor
  @AllArgsConstructor
  @DynamoDBTable(tableName="reception")
  public class Reception implements Serializable {

	  private static final long serialVersionUID = 1L;

	  String id;
	  String requestFilePath;
	  String responseFilePath;
	  String status;
	  LocalDateTime receptionTime;

	  @DynamoDBHashKey
	  @DynamoDBAutoGeneratedKey 
	  public String getId()
	  {
	    return id;
	  }
  }
  ```
- Repositoryインターフェイスを作成。

  ``` java
  @EnableScan
  public interface ReceptionRepository extends CrudRepository<Reception, String>{
	  List<Reception> findByRequestFilePath(String requestFilepath);
  }
  ```

### 動作確認
* コールドスタート時のVPCLambdaと起動スピードの大差はなし。
* SpringBoot起動時の速さに依存するため、性能の観点からは大きな改善は図れなかった。
* ただし、RDSインスタンスを常時起動し続けることに比べてコストメリットが高いため、特段の理由がなければサーバレスAPIでのデータの永続化層にはサーバレスDB（DynamoDB等）を使用するべき。
* サーバレス（＝非常駐）なRDBであるAurora Serverless V2がGAされれば、レスポンスが求められるAPIはDynamoDB、後続の（または定期的な）バッチ処理（特にRDBマストなSpringBatchなど）で、DB層の起動時間に余裕が持てる処理であればAurora Serverless v2の使用が最もコスト効率がよいと思われる。

## 改善点
* DynamoDBではRDBのシーケンスのような機能がデフォルトでは存在しないため、シーケンスの取得方法を別途検討する必要がある。
  * 以下のようなシーケンステーブルを作成し、numberをアトミックカウントとして設定することで一意性のある連番を取得可能にする。
  - DynamoDB で以下のようなテーブルを作成する。

    | Attribute | 型 | プライマリーキー | 説明 |
    | --- | --- | ---| ---|
    |name|String|○（Hash Key）|対象テーブルの名前|
    |current_number|Number|-|現在のシーケンスの値|
